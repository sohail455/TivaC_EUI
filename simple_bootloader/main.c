#include <stdint.h>
#include "stdbool.h"
#include "inc/hw_types.h"
#include "inc/hw_memmap.h"
#include "driverlib/fpu.h"
#include "driverlib/gpio.h"
#include "driverlib/pin_map.h"
#include "driverlib/flash.h"
#include "driverlib/sysctl.h"
#include "driverlib/eeprom.h"

#define FLASH_BLOCK_ADDR   0x00010000
#define NUMBER_OF_SECTORS  2
#define FLASHING_REQUEST   0xAAAAAAAA
#define EEPROM_CLEAR        0x00000000
#define FLAG_ADDRESS       0x400
#define FLASH_BLOCK        0x400

uint32_t ptr=0;
typedef void (*p_fun)(void);
p_fun jump;
uint32_t pui32Data=FLASHING_REQUEST;
uint32_t pui32Read=0;

const uint8_t new_image[] = {
                                   0x00,
                                   0x02,
                                   0x00,
                                   0x20,
                                   0x79,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x7f,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x81,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0x83,
                                   0x03,
                                   0x01,
                                   0x00,
                                   0xad,
                                   0xf1,
                                   0x08,
                                   0x0d,
                                   0x00,
                                   0x90,
                                   0x2a,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf0,
                                   0x01,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x28,
                                   0x49,
                                   0x00,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x28,
                                   0x49,
                                   0x04,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x27,
                                   0x49,
                                   0x02,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x27,
                                   0x49,
                                   0x43,
                                   0xf6,
                                   0x7f,
                                   0x60,
                                   0x08,
                                   0x60,
                                   0x26,
                                   0x49,
                                   0x01,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x25,
                                   0x49,
                                   0x00,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x1f,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf0,
                                   0x01,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x00,
                                   0x20,
                                   0x01,
                                   0x90,
                                   0x00,
                                   0x20,
                                   0x01,
                                   0x90,
                                   0x00,
                                   0x98,
                                   0x01,
                                   0x99,
                                   0x88,
                                   0x42,
                                   0x0f,
                                   0xd9,
                                   0x1e,
                                   0x48,
                                   0x00,
                                   0x68,
                                   0x40,
                                   0x08,
                                   0xfb,
                                   0xd3,
                                   0x1a,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf0,
                                   0x01,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x01,
                                   0x98,
                                   0x40,
                                   0x1c,
                                   0x01,
                                   0x90,
                                   0x00,
                                   0x98,
                                   0x01,
                                   0x99,
                                   0x88,
                                   0x42,
                                   0xef,
                                   0xd8,
                                   0x02,
                                   0xb0,
                                   0x70,
                                   0x47,
                                   0x08,
                                   0xb5,
                                   0x16,
                                   0x49,
                                   0x20,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x15,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf0,
                                   0x02,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x14,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf0,
                                   0x02,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x12,
                                   0x49,
                                   0x02,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x4f,
                                   0xf4,
                                   0x7a,
                                   0x70,
                                   0xff,
                                   0xf7,
                                   0xb1,
                                   0xff,
                                   0x0f,
                                   0x49,
                                   0x00,
                                   0x20,
                                   0x08,
                                   0x60,
                                   0x4f,
                                   0xf4,
                                   0x7a,
                                   0x70,
                                   0xff,
                                   0xf7,
                                   0xaa,
                                   0xff,
                                   0xf0,
                                   0xe7,
                                   0xc0,
                                   0x46,
                                   0x04,
                                   0xe6,
                                   0x0f,
                                   0x40,
                                   0x0c,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x00,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x04,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x28,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x24,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x50,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x1c,
                                   0x00,
                                   0x03,
                                   0x40,
                                   0x08,
                                   0xe6,
                                   0x0f,
                                   0x40,
                                   0x00,
                                   0x54,
                                   0x02,
                                   0x40,
                                   0x1c,
                                   0x55,
                                   0x02,
                                   0x40,
                                   0xfc,
                                   0x53,
                                   0x02,
                                   0x40,
                                   0x08,
                                   0x48,
                                   0x80,
                                   0xf3,
                                   0x08,
                                   0x88,
                                   0x08,
                                   0x49,
                                   0x08,
                                   0x68,
                                   0x40,
                                   0xf4,
                                   0x70,
                                   0x00,
                                   0x08,
                                   0x60,
                                   0x00,
                                   0xbf,
                                   0x00,
                                   0xbf,
                                   0x00,
                                   0xf0,
                                   0x10,
                                   0xf8,
                                   0x00,
                                   0x20,
                                   0xff,
                                   0xf7,
                                   0xbb,
                                   0xff,
                                   0x01,
                                   0x20,
                                   0x00,
                                   0xf0,
                                   0x0c,
                                   0xf8,
                                   0x00,
                                   0x02,
                                   0x00,
                                   0x20,
                                   0x88,
                                   0xed,
                                   0x00,
                                   0xe0,
                                   0xff,
                                   0xf7,
                                   0xe8,
                                   0xbf,
                                   0x70,
                                   0x47,
                                   0xfe,
                                   0xe7,
                                   0xfe,
                                   0xe7,
                                   0xfe,
                                   0xe7,
                                   0x01,
                                   0x20,
                                   0x70,
                                   0x47,
                                   0x00,
                                   0xbf,
                                   0xfe,
                                   0xe7
};


int main(void)
{
    //Enable system clock
    SysCtlClockSet(SYSCTL_SYSDIV_4 | SYSCTL_USE_PLL | SYSCTL_OSC_MAIN | SYSCTL_XTAL_16MHZ);
    // Enable the EEPROM0 peripheral
    SysCtlPeripheralEnable(SYSCTL_PERIPH_EEPROM0);
    while(!SysCtlPeripheralReady(SYSCTL_PERIPH_EEPROM0))
    {
    }
    // Initialise EEPROM
    EEPROMInit();
    // Read The flag from EEPROM
    EEPROMRead(&pui32Read, FLAG_ADDRESS, sizeof(pui32Read));
    // check the flag from EEPROM
    if(pui32Read == FLASHING_REQUEST)
    {
        //erase Flash before Flashing
        pui32Data = EEPROM_CLEAR;
        EEPROMProgram(&pui32Data, FLAG_ADDRESS, sizeof(pui32Data));
        uint8_t sector_counter=0;
        for(sector_counter=0; sector_counter < NUMBER_OF_SECTORS; sector_counter++)
        {
            FlashErase(FLASH_BLOCK_ADDR+sector_counter*(FLASH_BLOCK));
        }
        // Flash the data
        FlashProgram((uint32_t *)new_image, FLASH_BLOCK_ADDR, sizeof(new_image));
        ptr = *( uint32_t *)(FLASH_BLOCK_ADDR + 4);
        jump = (p_fun)ptr;
        __set_MSP(*(( uint32_t *)FLASH_BLOCK_ADDR));
        jump();
    }
    else
    {
        // Enable PORTF
        SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOF);
        // choose the configurations of pins
        GPIOPinTypeGPIOOutput(GPIO_PORTF_BASE, GPIO_PIN_2);
        GPIOPinTypeGPIOInput(GPIO_PORTF_BASE, GPIO_PIN_4);
        GPIOPadConfigSet(GPIO_PORTF_BASE, GPIO_PIN_4, GPIO_STRENGTH_2MA, GPIO_PIN_TYPE_STD_WPU);

        while(1)
        {
            // check the switch
            uint32_t switchStatus = GPIOPinRead(GPIO_PORTF_BASE, GPIO_PIN_4);
            if(switchStatus == 0)
            {
                EEPROMProgram(&pui32Data, FLAG_ADDRESS, sizeof(pui32Data));
                SysCtlReset();
            }
            // toggle the Blue led
            GPIOPinWrite(GPIO_PORTF_BASE, GPIO_PIN_2, GPIO_PIN_2);
            SysCtlDelay(2000000);
            GPIOPinWrite(GPIO_PORTF_BASE, GPIO_PIN_2, 0);
            SysCtlDelay(2000000);
        }

    }
}
